#!/bin/sh
export ETCDCTL_API=3
cd /TopStor/
echo $@ > /root/tmp
web="/var/www/html/des20/Data/DGstatus.log";
logging='/var/www/html/des20/Data/currentinfo2.log'
glog='/var/www/html/des20/Data/TopStor.log'
pool=` echo $@ | awk '{print $1}'`;
userreq=` echo $@ | awk '{print $2}'`;
privilege="DiskGroups";
contrun=`./privthis.sh $privilege $userreq`;
if [[ $contrun == 'true' ]]
then
 myhost=`hostname -s`
 currentreq=`/pace/etcdget.py requests/DGdestroypool --prefix`
 echo $currentreq | grep $myhost
 if [ $? -eq 0 ];
 then
  exit
 else
  /pace/etcdput.py requests/DGdestroypool/$myhost $myhost/$userreq
 fi
  /TopStor/logmsg.py DGst5 info $userreq $pool
 waiting=1
 while [ $waiting -eq 1 ];
 do
  sleep 1
  pgrep zpool
  if [ $? -ne 0 ];
  then
   waiting=0
  fi
 done
 /sbin/zpool export -f $pool
 sleep 1
 /sbin/zpool import $pool
 sleep 1
 /sbin/zpool destroy -f $pool 2>/root/dgdestroyerror
 if [ $? -ne 0 ]; then
   /TopStor/logmsg.py DGfa5 error $userreq $pool
 else
  crontab -l | grep -v Snap > /TopStordata/cronfile
  crontab -r 
  crontab /TopStordata/cronfile
  ETCDCTL_API=3 /pace/etcddel.py pools $pool
  ETCDCTL_API=3 /pace/etcddel.py balance $pool
  ETCDCTL_API=3 /pace/etcddel.py vol $pool

  echo > /etc/exports
   /TopStor/logmsg.py DGsu5 info $userreq $pool
 fi 
fi
/pace/etcddel.py requests/DGdestroypool/$myhost $myhost/$userreq
 /pace/putzpool.py
