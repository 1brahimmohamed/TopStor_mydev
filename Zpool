#!/bin/sh
sleep 300
export ETCDCTL_API=3
echo $@ > /root/Zpoolparam
pool=`echo $3 | awk -F'/' '{print $3}'`
x=`pgrep Zpool -c`
if [ $x -gt 1 ];
then
 exit
fi
echo $@ > /root/Zpooltmp
success=1;
myhost=`hostname`
ETCDCTL_API=3 /pace/etcdget.py cannotimport/$myhost |  grep $pool
if [ $? -eq 0 ];
then
 ETCDCTL_API=3 /pace/etcddel.py lockedpools/$pool
 exit
fi
/sbin/zpool $@ > /root/Zpool
if [ $? -ne 0 ];
then
 success=0
 /sbin/zpool import $pool 
 if [ $? -ne 0 ];
 then 
  ETCDCTL_API=3 /TopStor/logmsg.py Zpfa02 warning system $pool
  myhost=`hostname`
  cannotimport=`ETCDCTL_API=3 /pace/etcdget.py cannotimport/$myhost`
  slash='/'
  if [ $cannotimport -eq -1 ];
  then
   cannotimport=''
   slash=''
  fi
  ETCDCTL_API=3 /pace/etcdput.py cannotimport/$myhost ${cannotimport}${slash}${pool}
 else
  success=1;
 fi
fi
if [ $success -eq 1 ]; 
then
 ETCDCTL_API=3 /TopStor/logmsg.py Zpsu02 info system $pool
 /sbin/zpool set cachefile=$3 $pool
 /pace/putzpool.py 
 ETCDCTL_API=3 /pace/etcddel.py lockedpools/$pool
fi 
ETCDCTL_API=3 /pace/etcddel.py lockedpools/$pool
